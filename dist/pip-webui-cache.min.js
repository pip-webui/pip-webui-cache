!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,(t.pip||(t.pip={})).cache=e()}}(function(){return function e(t,n,o){function r(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(i)return i(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var u=n[a]={exports:{}};t[a][0].call(u.exports,function(e){var n=t[a][1][e];return r(n||e)},u,u.exports,e,t,n,o)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<o.length;a++)r(o[a]);return r}({1:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t,n,o){this.enabled=e,this.enableLogs=t,this.models=n,this.prefix=o}return e}();n.CacheConfigService=o;var r=function(){function e(){"ngInject";this.enabled=!0,this.enableLogs=!1,this.models=[],this.prefix="PipCache"}return e.prototype.$get=function(){"ngInject";return null==this._service&&(this._service=new o(this.enabled,this.enableLogs,this.models,this.prefix)),this._service},e}();angular.module("pipCache").provider("pipCacheConfig",r)},{}],2:[function(e,t,n){"use strict";function o(e){"ngInject";e.interceptors.push(["$q","pipCache","pipCacheConfig",function(e,t,n){return{request:function(o){if(!n.enabled)return o;for(var r=0,i=t.models;r<i.length;r++){var a=i[r],s=function(n){for(var r=0,i=Object.keys(n.interceptors);r<i.length;r++){var a=i[r],s=function(r){var i=n.interceptors[r],a=i.match.exec(o.url);if(a)switch(o.method){case"GET":switch(r){case"item":return{value:t.getItem(n.name,i.getKey(a),i.options).then(function(r){return r?(o.timeout=e.defer().promise,e.reject({cachedData:r})):(o.onResponse=function(e){t.setItem(n.name,e,i.options)},o)})};case"collection":return{value:t.getItems(n.name,{httpParams:o.params,interceptor:i}).then(function(r){if(r){o.timeout=e.defer().promise;var a=i.responseModify?i.responseModify.itemsToResponse(r):r;return e.reject({cachedData:a})}return o.onResponse=function(e){var r=i.responseModify?i.responseModify.responseToItems(e):e;t.setItems(n.name,r,{httpParams:o.params,interceptor:i})},o})};default:console.error("Unknown type of interceptor ("+r+")")}case"POST":case"PUT":switch(r){case"item":case"collection":o.onResponse=function(e){t.setItem(n.name,e,{removeTotal:"POST"===o.method})}}case"DELETE":switch(r){case"item":o.onResponse=function(e){t.deleteItems(n.name,[i.getKey(a)])}}}}(a);if("object"==typeof s)return s}}(a);if("object"==typeof s)return s.value}return o},response:function(e){return e.config.hasOwnProperty("onResponse")&&"function"==typeof e.config.onResponse&&e.config.onResponse(e.data),e},responseError:function(t){return t&&t.cachedData?e.resolve({data:t.cachedData}):e.reject(t)}}}])}o.$inject=["$httpProvider"],Object.defineProperty(n,"__esModule",{value:!0}),angular.module("pipCache").config(o)},{}],3:[function(e,t,n){"use strict";function o(e){var t=new i,n=_.cloneDeep(e);return e&&(e.hasOwnProperty("offset")&&(t.offset=parseInt(e.offset,10),delete n.offset),e.hasOwnProperty("limit")&&(t.limit=parseInt(e.limit,10),delete n.limit)),[t,n]}var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(){}return e}();n.PipCachePaginationParams=i,n.extractPaginationDefault=o;var a=function(){function e(){}return e}();n.PipCacheInterceptorOptions=a;var s=function(){function e(){}return e}();n.PipCacheInterceptorSettings=s;var c=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(s);n.PipCacheInterceptorItemSettings=c;var l=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(s);n.PipCacheInterceptorCollectionSettings=l;var u=function(){function e(){}return e}();n.PipCacheModel=u},{}],4:[function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function a(e){try{c(o.next(e))}catch(e){i(e)}}function s(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(a,s)}c((o=o.apply(e,t||[])).next())})},r=this&&this.__generator||function(e,t){function n(e){return function(t){return o([e,t])}}function o(n){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,i&&(a=i[2&n[0]?"return":n[0]?"throw":"next"])&&!(a=a.call(i,n[1])).done)return a;switch(i=0,a&&(n=[0,a.value]),n[0]){case 0:case 1:a=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,i=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(a=s.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){s=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){s.label=n[1];break}if(6===n[0]&&s.label<a[1]){s.label=a[1],a=n;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(n);break}a[2]&&s.ops.pop(),s.trys.pop();continue}n=t.call(e,s)}catch(e){n=[6,e],i=0}finally{r=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var r,i,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return{next:n(0),throw:n(1),return:n(2)}};Object.defineProperty(n,"__esModule",{value:!0});var i=e("./cache.models"),a=function(){function e(){}return e}(),s=function(){function e(e){this.config=e,this.openedDbs=new Map}return e.prototype.getDbName=function(e){if(!e)throw new Error("Model name should be defined");return this.config.prefix+e.charAt(0).toUpperCase()+e.slice(1)},e.prototype.getDb=function(e){if(!e||!e.name)throw new Error("Model should be defined");var t=this.getDbName(e.name);if(this.openedDbs.has(t))return this.openedDbs.get(t);var n=new Dexie(t),o=e.options.key||"id";return n.version(2).stores({items:o,hashes:"hash",lastRead:"",meta:""}),this.openedDbs.set(t,n),n},e.prototype.getModel=function(e){return this.models.find(function(t){return t.name===e})},Object.defineProperty(e.prototype,"models",{get:function(){return this.config.models||[]},enumerable:!0,configurable:!0}),e.prototype.getItem=function(e,t,n){return o(this,void 0,void 0,function(){var o,i,a,s,c,l,u;return r(this,function(r){switch(r.label){case 0:return o=this.getModel(e),i=this.getDb(o),[4,Promise.all([i.table("lastRead").get(t),i.table("items").get(t)])];case 1:return a=r.sent(),s=a[0],c=a[1],l=n&&n.maxAge||o.options.maxAge,u=s+l<=(new Date).valueOf(),this.config.enableLogs&&(console.groupCollapsed("[PipCache] GET single item #"+t),console.log("Item: ",c),console.log("Expired: ",u),console.log("Expired at: ",new Date(s)),console.groupEnd()),[2,u?null:c]}})})},e.prototype.getItems=function(e,t){return o(this,void 0,void 0,function(){var n,o,a,s,c,l,u,f,p,h,d,g,m=this;return r(this,function(r){return n=this.getModel(e),o=this.getDb(n),a=n.options.key||"id",s=_.get(t,"interceptor.options.maxAge",n.options.maxAge),this.config.enableLogs&&(console.groupCollapsed("[PipCache] GET collection of items"),console.log("Payload: ",t)),c=_.get(t,"interceptor.extractPagination",i.extractPaginationDefault)(t&&t.httpParams),l=c[0],u=c[1],f=0!==Object.keys(l).length,p=_.defaultsDeep(l,{offset:0,limit:0}),h=p.offset,d=p.limit,g=u&&Object.keys(u).length?objectHash.MD5(u):"",[2,o.table("hashes").get(g).then(function(e){var t=e&&e.total&&e.total.value&&e.total.lastRead+s>=(new Date).valueOf()?e.total.value:void 0,n=h+d,r=f?d?t&&n>t?t-h:d:t?t-h:d:t,i=e&&e.idxMap||[];if(f)if(d){if(i=i.filter(function(e,t){return t>=h&&t<n}),i.length!==r)return m.config.enableLogs&&(console.log("There's not enough information about indexes"),console.groupEnd()),Promise.reject(null)}else{if(void 0===t)return m.config.enableLogs&&(console.log("We want to return all items, but we don't know how many they are"),console.groupEnd()),Promise.reject(null);if(i=i.filter(function(e,t){return t>=h}),i.length!==r)return m.config.enableLogs&&(console.log("Not all items presented in cache"),console.groupEnd()),Promise.reject(null)}else if(void 0===t)return m.config.enableLogs&&(console.log("We want to return all items, but we don't know how many they are"),console.groupEnd()),Promise.reject(null);return Promise.all([Promise.resolve(i),f||g?o.table("items").where(a).anyOf(i).toArray():o.table("items").toArray(),f||g?o.table("lastRead").where("").anyOf(i).toArray():o.table("lastRead").toArray()])}).then(function(e){var t=e[0],n=e[1],o=e[2];if(!n||n.length!==t.length||!o||o.length!==t.length)return m.config.enableLogs&&(console.warn("Not all items presented in cache"),console.groupEnd()),null;if(Math.min.apply(Math,o)+s<=(new Date).valueOf())return m.config.enableLogs&&(console.log("Items was expired"),console.groupEnd()),null;var r=t.map(function(e){return n.find(function(t){return t[a]===e})});return m.config.enableLogs&&(console.log("Items: ",r),console.groupEnd()),r}).catch(function(e){if(null===e)return null;throw e})]})})},e.prototype.setItem=function(e,t,n){return o(this,void 0,void 0,function(){var o,i,a,s=this;return r(this,function(r){return o=this.getModel(e),i=this.getDb(o),a=[i.table("lastRead").put((new Date).valueOf(),t[o.options.key]),i.table("items").put(t)],n&&n.removeTotal&&a.push(i.table("hashes").toCollection().modify({total:void 0})),[2,Promise.all(a).then(function(e){return s.config.enableLogs&&(console.groupCollapsed("[PipCache] SET single item #"+t[o.options.key]),console.log("Item: ",e[1]),console.log("Readed at: ",new Date),console.groupEnd()),e[1]})]})})},e.prototype.setItems=function(e,t,n){return o(this,void 0,void 0,function(){var o,s,c,l,u,f,p,h,d,g,m,v,b,y,w,P=this;return r(this,function(r){return o=this.getModel(e),s=o.options.key||"id",c=this.getDb(o),l=(new Date).valueOf(),u=t.map(function(e){return e[s]}),p=_.get(n,"interceptor.extractPagination",i.extractPaginationDefault)(n&&n.httpParams),h=p[0],d=p[1],g=0!==Object.keys(h).length,m=_.defaultsDeep(h,{offset:0,limit:0}),v=m.offset,b=m.limit,y=d&&Object.keys(d).length?objectHash.MD5(d):"",w=[c.table("lastRead").bulkPut(new Array(t.length).fill(l),u),c.table("items").bulkPut(t),c.table("hashes").get(y).then(function(e){var n=e||Object.assign(new a,{hash:y,total:{},idxMap:[]});return u.forEach(function(e,t){return n.idxMap[t+v]=e}),(g&&h.limit&&t.length&&t.length<h.limit||!g)&&(f=(h.offset||0)+t.length,n.total={value:f,lastRead:l}),c.table("hashes").put(n)})],[2,Promise.all(w).then(function(){return P.config.enableLogs&&(console.groupCollapsed("[PipCache] SET collection of items"),console.log("Payload: ",n),console.log("Items: ",t),console.log("Hash:",y),console.log("Last read at: ",new Date),_.isUndefined(f)||console.log("New total for hash ["+y+"]: "+f),console.groupEnd()),t})]})})},e.prototype.deleteItems=function(e,t){return o(this,void 0,void 0,function(){var n,i,a=this;return r(this,function(s){return n=this.getModel(e),i=this.getDb(n),[2,Promise.all([i.table("lastRead").bulkDelete(t),i.table("items").bulkDelete(t),i.transaction("rw",i.table("hashes"),function(){return o(a,void 0,void 0,function(){return r(this,function(e){switch(e.label){case 0:return[4,i.table("hashes").toCollection().modify(function(){var e,n=this;t.forEach(function(t){var o=n.value.idxMap.findIndex(function(e){return e===t});o>=0&&(n.value.idxMap.splice(o,1),e=!0)}),e&&delete this.value.total})];case 1:return e.sent(),[2]}})})})]).then(function(){a.config.enableLogs&&(console.groupCollapsed("[PipCache] DELETE"),console.log("Keys: ",t),console.groupEnd())})]})})},e.prototype.clear=function(e){return o(this,void 0,void 0,function(){var t=this;return r(this,function(n){return[2,new Promise(function(n){var o=[];e?(Array.isArray(e)?o.push.apply(o,e.map(function(e){return t.getDbName(e)})):o.push(t.getDbName(e)),n(o)):n(Dexie.getDatabaseNames())}).then(function(e){var n=e.filter(function(e){return e.startsWith(t.config.prefix)});t.config.enableLogs&&console.log("databases to delete: ",e);for(var o=[],r=0,i=n;r<i.length;r++){var a=i[r];try{var s=t.openedDbs.has(a)?t.openedDbs.get(a):new Dexie(a);o.push(s.table("items").clear()),o.push(s.table("meta").clear()),o.push(s.table("lastRead").clear()),o.push(s.table("hashes").clear())}catch(e){t.config.enableLogs&&console.warn("Error opening database "+a)}}return Promise.all(o)}).then(function(n){return t.config.enableLogs&&(console.log("[PipCache] CLEAR"),e?console.log("Model(s): ",e):console.log("all models")),null})]})})},e}();n.CacheService=s;var c=function(){function e(e){"ngInject";this.pipCacheConfigProvider=e}return e.$inject=["pipCacheConfigProvider"],Object.defineProperty(e.prototype,"models",{get:function(){return this.pipCacheConfigProvider.models},enumerable:!0,configurable:!0}),e.prototype.registerModel=function(e){return!!e&&(!this.models.find(function(t){return t.name===e.name})&&(this.models.push(e),!0))},e.prototype.$get=function(){"ngInject";return null==this._service&&(this._service=new s(this.pipCacheConfigProvider)),this._service},e}();angular.module("pipCache").provider("pipCache",c)},{"./cache.models":3}],5:[function(e,t,n){"use strict";function o(e){for(var t in e)n.hasOwnProperty(t)||(n[t]=e[t])}Object.defineProperty(n,"__esModule",{value:!0}),angular.module("pipCache",[]),e("./cache-config.service"),e("./cache.service"),e("./cache.interceptor"),o(e("./cache.models")),o(e("./cache-config.service")),o(e("./cache.service"))},{"./cache-config.service":1,"./cache.interceptor":2,"./cache.models":3,"./cache.service":4}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),e("./cache/index"),function(e){for(var t in e)n.hasOwnProperty(t)||(n[t]=e[t])}(e("./cache/index"))},{"./cache/index":5}]},{},[6])(6)});
//# sourceMappingURL=pip-webui-cache.min.js.map
